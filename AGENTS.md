# AGENTS.md（強制 / Repository Baseline）

このリポジトリで GitHub Copilot Coding Agent が作業するときの強制ルール。
下位ディレクトリに別の AGENTS.md を置く運用は原則禁止（例外は末尾）。

前提：Copilot coding agent は「1タスクにつき1PR」しか作れない。よって大きい作業は分割が必須。

---

## 1) 最優先ルール（毎回）
- 目的 / 受け入れ条件（AC）/ 非対象 / 制約 を最初に固定（不足が致命的なら質問は1回だけ）。
- 変更は最小差分（無関係な整形・一括リファクタ・不要依存追加をしない）。
- 最低1つの検証（テスト/ビルド/静的解析）を行い、できない場合は理由と代替を書く。
- 秘密情報を追加・出力しない（鍵・トークン・個人情報・内部URL等）。
- **捏造禁止**：ID/URL/固有名/数値/事実を根拠なく作らない。不明は `TBD` / `不明（要確認）` と明記する。
- **質問制限**：質問は1回のメッセージで最大3項目まで。質問なしで進められる場合は質問しない。
- **出力言語**：出力は日本語。見出し＋箇条書き中心で簡潔に。
- **書き込み失敗対策**：edit 後に read で空でないことを確認。空なら小チャンク（2,000〜5,000文字）に分割して再試行（最大3回）。

---

## 2) 計画（DAG）と分割（15分超は必須）
### 2.1 まずDAG（依存関係）+見積（分）を作る
次のいずれかに当てはまる場合、実装開始前に `work/<task>/plan.md` を作る：
- 大規模/大量/生成/複数モジュール/複数サービス/仕様→実装
- 影響範囲や検証方法が不明
- 15分を超えそう、またはレビューが重くなりそう

見積は R(調査)+P(計画)+I(実装)+V(検証)+F(仕上げ) の合計（各ノードに分単位で付与）。

### 2.1.1 見積の最低基準（過小申告防止）

以下の目安を下回る見積は根拠を明記すること：
- 新規スクリプト（.sh/.py/.ts）1ファイルあたり: 最低 3分
- 新規ドキュメント 1ファイルあたり: 最低 2分
- 既存ファイル更新 1ファイルあたり: 最低 1分
- 品質レビュー 3回: 最低 3分
- 合計ファイル数 × 最低時間 < 見積合計 の場合、見積の根拠を plan.md に記載すること

### 2.2 分割判定（機械的に実行 — エージェントの裁量なし）

以下の判定を **必ず** 実行し、結果を `plan.md` の `## 分割判定` セクションに記録する：

```
見積合計 = plan.md の全ノード見積の合計（分）

if 見積合計 > 15:
    判定 = "SPLIT_REQUIRED"
    → §2.3 分割モード（Plan-Only）に入る
    → 実装ファイルの作成・変更は禁止
    → subissues.md を必ず作成する
    → PR タイトルに [WIP] を付与する
    → ここで作業を終了する（Execute には進まない）

elif 不確実性 == "高" or 不確実性 == "中":
    判定 = "SPLIT_REQUIRED"
    → 上記と同じ

else:  # 見積合計 ≤ 15 かつ 不確実性 == "低"
    判定 = "PROCEED"
    → 実装に進んでよい
```

**禁止事項**:
- 見積合計 > 15 の場合に「分割不要」「1バッチで実行可能」「まとめて実施」と判断すること
- Custom Agent の記述を根拠に分割判定を覆すこと（§8 により AGENTS.md が常に優先）

### 2.3 分割モード（Plan-Only）— 計画のみ作成し、実装は一切しない

> **このセクションは全 Custom Agent に対して強制適用される。Custom Agent に異なる記述がある場合でも本セクションが優先される。**

分割モードに入った場合、**この PR では計画ファイルのみを作成し、実装（コード・スクリプト・設定ファイル等の作成・変更）は一切行わない。**

#### 作成するファイル（これ以外は作成・変更しない）
- `work/<task>/plan.md`：DAG+見積+リスク+検証計画
- `work/<task>/subissues.md`：Sub Issue の本文（下記の機械可読フォーマットで記述）
- `work/<task>/work-status.md`：各ステップの進捗（✅/⏭️/❌）
- `work/<task>/README.md`：作業ディレクトリの入口

#### 禁止事項（分割モード中）
- 実装ファイルの作成・変更（.sh, .py, .sql, .ts, .js, .html, .css 等）
- 外部サービスへの接続を伴うコマンドの実行（`az`, `npm`, `docker` 等。環境調査目的も含む）
- `docs/` 配下のドキュメント新規作成（設計書等は最初の Sub に含める）

※ 静的解析ツール（`markdownlint` 等）による計画ファイルの品質チェックは許可。

#### plan.md の必須セクション（以下をすべて含むこと）

plan.md の **1行目〜4行目** に以下のHTMLコメントを記載する（CI自動検証に使用）:

```
<!-- estimate_total: XX -->
<!-- split_decision: PROCEED or SPLIT_REQUIRED -->
<!-- subissues_count: N -->
<!-- implementation_files: true or false -->
```

また、plan.md 本文に `## 分割判定` セクションを必須で含めること:

```
## 分割判定（必須）

- 見積合計: XX 分
- 15分以下か: YES / NO
- 不確実性: 低 / 中 / 高
- 判定結果: PROCEED / SPLIT_REQUIRED
- 判定根拠: AGENTS.md §2.2 の条件「見積合計 > 15分」に該当 / 非該当
- （SPLIT_REQUIRED の場合）subissues.md: 作成済み / 未作成
- （PROCEED の場合）実装に進む理由: 見積 XX分 ≤ 15分、不確実性: 低
```

**「判定結果: PROCEED」と記載できる条件**:
- 見積合計 ≤ 15分 **かつ** 不確実性が「低」の場合のみ（「中」または「高」の場合は SPLIT_REQUIRED）

#### Sub Issue の扱い
- `subissues.md` に Sub Issue を **以下の機械可読フォーマット** で出力する
- **Copilot coding agent が PR 作成セッション内で GitHub Issue を直接作成することは行わない**
- Sub Issue の GitHub 上での作成は、GitHub Actions ワークフロー（`create-subissues-from-pr.yml`）が、人間による `create-subissues` ラベル付与をトリガーに自動実行する

#### `subissues.md` のフォーマット（必須 — 自動 Issue 作成に必要）

各 Sub Issue を以下の HTML コメント形式のメタデータヘッダーで開始する。
Sub Issue 間は `---`（水平線）で区切る。

```
<!-- subissue -->
<!-- title: Sub Issue のタイトル -->
<!-- labels: label1, label2 -->
<!-- custom_agent: Agent名 -->
<!-- depends_on: 1,3 -->

[Issue 本文（Markdown）]

---
```

- `<!-- subissue -->` が各ブロックの開始マーカー（必須）
- `<!-- title: ... -->` が Issue タイトル（必須）
- `<!-- labels: ... -->` がラベル（カンマ区切り。省略可）
- `<!-- custom_agent: ... -->` が Copilot アサイン時の Custom Agent 名（省略可）
- `<!-- depends_on: ... -->` が依存先 Sub のブロック番号（カンマ区切り。省略可。省略時＝依存なし＝ルートノード）。plan.md の DAG と一致させること。依存先 Sub が完了するまで Copilot はアサインされない（`create-subissues-from-pr.yml` が制御）。
- メタデータの後の Markdown テキストが Issue 本文になる

#### PR description の必須記載
- 元 Issue 番号をリンクする。以下のいずれかの方法で記載する（ワークフローが親子紐付けに使用。優先順位順）:
  1. `Fixes #N` / `Closes #N` / `Resolves #N`（GitHub 標準の closing reference — 推奨）
  2. `<!-- parent-issue: #N -->`（HTMLコメント形式 — レガシー互換）
- Sub Issue 一覧と「次にやる最初の Sub」を記載する

#### PR の完了条件
- 上記の計画ファイルをコミットし、PR タイトルに `[WIP]` を付与する
- PR description に上記の必須記載を含める
- **作業を完了する**（追加の実装やレビューは行わない）
- PR の Close/Merge は人間が判断する（エージェントは行わない）

#### 品質レビュー
- 分割モードでは §7 の「3回レビュー」は **省略する**
- plan.md と subissues.md の簡易セルフチェック（漏れ・矛盾がないか）のみ実施する

---

## 3) 直列/並列の判断と共有（衝突を避ける）
直列（同一Subに寄せる）：
- 同じファイル/同じ公開I/F（API/スキーマ/設定キー）を高確率で触る
- 移行/互換/後戻り困難な変更
- 仕様確定→実装の依存が強い

並列（別Sub/別PRに分離）：
- 対象ディレクトリ/サービスが分離している
- 追記中心で衝突しにくい（例：モジュール別ドキュメント）
- テスト追加が独立

共有方法（必須）：
- 共有すべき前提（契約/一覧/決定事項）は **PRコメントではなくファイル** に残す（後続が確実に読める形）。

---

## 4) `work/` の必須構造（共有と再試行のため）
`work/<task>/`（<task>は `issue-<番号>` があればそれ、なければ短い英数字）
- `README.md`：入口（何を見るべきか）
- `plan.md`：DAG+見積+リスク+検証
- `subissues.md`：分割が必要な場合のみ
- `onboarding.md`：初見/入口不明のときのみ
- `contracts/`：仕様/契約/決定事項（根拠付き）
- `artifacts/`：生成物/抽出物（巨大なら分割）

詳細手順は skills を参照（必要なときだけ）：
- task-dag-planning / work-artifacts-layout / large-output-chunking / repo-onboarding-fast

---

## 5) 巨大出力（必須：失敗とレビュー困難を防ぐ）
- 目安：1ファイル **50,000文字超** になりそうなら分割
- 推奨：**20,000文字以下** で「意味のある単位（章/サービス/API）」に分割
- 分割保存：`artifacts/<name>.index.md` + `artifacts/<name>.part-0001.md` …（結合順はindexに書く）

---

## 6) PRに必ず書く（短くてよい）
- 目的 / 変更点 / 影響範囲 / 検証結果 / 既知の制約 / 次にやるSub（残作業）

---

## 7) 最終品質レビュー（必須：成果物の品質確保）

> **例外**: §2.3 分割モード（Plan-Only）の場合は、本セクションの3回レビューを **省略する**。plan.md と subissues.md の簡易セルフチェックのみ実施する。

> **注意（誤適用の防止）**: 以下の場合は分割モードの例外に**該当しない**。必ず3回レビューを実施すること：
> - PR に実装ファイル（.sh, .py, .sql, .ts, .js, .html, .css 等）の**作成または変更**が含まれる場合
> - Sub Issue 由来の PR であっても、実装を含む場合
> - PR のステータスが WIP / Partial / Blocked であっても、実装ファイルがコミットされている場合
>
> **判定基準**: `git diff --name-only` の結果に `work/` 配下以外の実装ファイルが1つでも含まれる場合、3回レビューは**必須**。

成果物が依頼の目的を確実に達成するため、**異なる観点で3度のレビュー** を実施する。

### 7.1 レビュー実施手順
各回のレビューで以下を行う：
1. **観点を変える**（例：機能完全性 → ユーザー視点 → 保守性/スケーラビリティ）
2. **問題点をリストアップ**：10～50個の問題点/不足/改善点を抽出
3. **解決策を立案**：リストアップした各問題に対して具体的な解決策を提案
4. **解決策を実行**：提案した解決策を成果物に反映
5. **更新版を生成**：改善内容を適用した新しい版を作成

### 7.2 3つの異なる観点（例）
- **1回目：機能完全性・要件達成度**：依頼の要件/AC/制約がすべて満たされているか
- **2回目：ユーザー/利用者視点**：使いやすさ、分かりやすさ、納得度
- **3回目：保守性・拡張性・堅牢性**：保守のしやすさ、将来の拡張可能性、エラー処理の完全性

> ※ 観点の詳細は、依頼の性質（設計/実装/ドキュメント/レビュー等）に応じて柔軟に選択。

### 7.3 出力方法
- 各回のレビューと改善プロセスは `work/<Custom Agent Name>/<Issue Number>/` と、**PRの本文**に出力する（README 等で参照のみ記載）
- **最終版のみを成果物として出力する**（中間版は不要）

---

## 8) Custom Agent との優先関係
- Custom Agent（`.github/agents/*.agent.md`）は、**AGENTS.md を継承し、固有の追加ルールのみを記載する**。
- **AGENTS.md の記述と Custom Agent の記述が矛盾する場合は、AGENTS.md が優先される。**
- 特に §2.3（分割モード）は全 Custom Agent に対して強制適用される。Custom Agent 側で「分割時に実装を行う」等の指示があっても、AGENTS.md §2.3 が優先される。

---

## 9) 例外（下位AGENTS.mdを置く場合）
- 置くのは「そのディレクトリ固有の追加ルール」だけ。
- 必ず「ルートAGENTS.mdを継承し、追加/上書き点のみ記載」と明記する。
