name: Advance Sub Issues

# PRãƒãƒ¼ã‚¸æ™‚ã«ã€ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸ Sub Issue ã®ä¾å­˜é–¢ä¿‚ã‚’è©•ä¾¡ã—ã€
# ä¾å­˜ãŒå…¨ã¦è§£æ±ºã•ã‚ŒãŸ Sub Issue ã« Copilot + Custom Agent ã‚’è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³ã™ã‚‹ã€‚
#
# å¯¾å¿œã™ã‚‹ä¾å­˜é–¢ä¿‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã©ã¡ã‚‰ã‚‚æ¤œå‡ºï¼‰:
#   - ## â³ å‰ææ¡ä»¶ï¼ˆDependenciesï¼‰ ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã® - #NNN è¡Œï¼ˆIssueç•ªå·å½¢å¼ï¼‰
#   - <!-- depends_on: 213,216 --> HTML ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆIssueç•ªå·å½¢å¼ï¼‰
#
# è¦ª Issue ã®ç‰¹å®šæ–¹æ³•ï¼ˆå„ªå…ˆé †ï¼‰:
#   Method 1: Sub Issue body ã® <!-- parent-issue: #NNN --> ï¼ˆæ–°è¦ä½œæˆåˆ†ï¼‰
#   Method 2: Sub Issue body ã® <!-- pr-number: NNN --> â†’ ãã® PR ã® closingIssuesReferences
#   Method 3a: GraphQL trackedInIssues ã‚¯ã‚¨ãƒªï¼ˆæ—¢å­˜ Sub Issue ã«å¯¾å¿œï¼‰
#   Method 3b: <!-- subissues-created --> PR ã‚³ãƒ¡ãƒ³ãƒˆçµŒç”±ï¼ˆ3a å¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

on:
  pull_request:
    types: [closed]

concurrency:
  group: advance-subissues-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  advance:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COPILOT_PAT: ${{ secrets.COPILOT_PAT }}
      REPO: ${{ github.repository }}
      PR_HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
      PR_NUMBER: ${{ github.event.pull_request.number }}

    steps:
      - name: Advance sub issues on PR merge
        run: |
          set -euo pipefail

          # GitHub API state propagation: PR merge â†’ issue state "closed" ã®åæ˜ ã‚’å¾…ã¤
          # (å®Ÿæ¸¬ã§ 2-3ç§’ã§GitHub REST API ã«åæ˜ ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚ä¾å­˜ãƒã‚§ãƒƒã‚¯ã®å‰ã«ä½™è£•ã‚’æŒãŸã›ã‚‹)
          sleep 3

          if [[ -z "${COPILOT_PAT:-}" ]]; then
            echo "WARNING: COPILOT_PAT ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Copilot ã‚¢ã‚µã‚¤ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚" >&2
          fi

          OWNER="${REPO%/*}"
          REPO_NAME="${REPO#*/}"

          # â”€â”€ assign_copilot() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # auto-software-dev-webapp.yml / create-subissues-from-pr.yml ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³
          assign_copilot() {
            local issue_num="$1"
            local custom_agent="${2:-}"
            local base_branch="${3:-main}"
            local custom_instructions="${4:-}"

            echo "=== Copilot ã‚¢ã‚µã‚¤ãƒ³é–‹å§‹: Issue #${issue_num} ==="
            echo "  custom_agent: ${custom_agent}"
            echo "  base_branch: ${base_branch}"

            # å†ªç­‰åŒ–ã‚¬ãƒ¼ãƒ‰: æ—¢ã« copilot-swe-agent ãŒã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            local current_assignees
            current_assignees=$(curl -s \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO}/issues/${issue_num}" \
              | python3 /dev/fd/3 3<<'PY'
          import sys, json
          try:
              d = json.load(sys.stdin)
              if not isinstance(d, dict):
                  print('false')
                  sys.exit(0)
              assignees = [a.get('login', '') for a in d.get('assignees', [])]
              print('true' if 'copilot-swe-agent' in assignees or 'Copilot' in assignees else 'false')
          except Exception:
              print('false')
          PY
            ) || true

            if [[ "${current_assignees}" == "true" ]]; then
              echo "  copilot-swe-agent ã¯æ—¢ã«ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
              return 0
            fi

            # å†ªç­‰åŒ–ã‚¬ãƒ¼ãƒ‰: å¯¾è±¡ Issue ã«ç´ã¥ã Open ãª PR ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            local existing_prs
            existing_prs=$(curl -s \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO}/issues/${issue_num}/timeline?per_page=100" \
              | python3 /dev/fd/3 3<<'PY'
          import sys, json
          try:
              events = json.load(sys.stdin)
              if not isinstance(events, list):
                  print('false')
                  sys.exit(0)
          except Exception:
              print('false')
              sys.exit(0)
          for e in events:
              if e.get('event') == 'cross-referenced':
                  source = e.get('source', {}).get('issue', {})
                  pr = source.get('pull_request', {})
                  if pr and source.get('state') == 'open':
                      print('true')
                      sys.exit(0)
          print('false')
          PY
            ) || true

            if [[ "${existing_prs}" == "true" ]]; then
              echo "  Issue #${issue_num} ã«ç´ã¥ã Open ãª PR ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
              return 0
            fi

            if [[ -z "${COPILOT_PAT:-}" ]]; then
              echo "WARNING: COPILOT_PAT ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Copilot ã‚¢ã‚µã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚" >&2
              return 2  # 2 = skipped (not failure)
            fi

            local max_assign_retry=3
            local assign_wait=5
            local assign_success=false

            for assign_attempt in $(seq 1 "${max_assign_retry}"); do
              echo "  ã‚¢ã‚µã‚¤ãƒ³è©¦è¡Œ ${assign_attempt}/${max_assign_retry}..."

              # 1å›ã®ã‚¯ã‚¨ãƒªã§ bot_id / issue_node_id / repo_node_id ã‚’ã¾ã¨ã‚ã¦å–å¾—
              local query_result
              query_result=$(GH_TOKEN="${COPILOT_PAT}" gh api graphql \
                -f query="
          query(\$issueNumber: Int!) {
            repository(owner: \"${OWNER}\", name: \"${REPO_NAME}\") {
              id
              issue(number: \$issueNumber) { id }
              suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                nodes {
                  login
                  ... on Bot { id databaseId }
                }
              }
            }
          }
                " \
                -F issueNumber="${issue_num}" \
                2>&1) || true

              if [[ -z "${query_result}" ]]; then
                echo "WARNING: GraphQL ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©¦è¡Œ ${assign_attempt}/${max_assign_retry}" >&2
                sleep "${assign_wait}"
                assign_wait=$((assign_wait * 2))
                continue
              fi

              local bot_id issue_node_id repo_node_id
              IFS=$'\t' read -r bot_id issue_node_id repo_node_id < <(echo "${query_result}" | python3 /dev/fd/3 3<<'PY'
          import sys, json
          try:
              d = json.load(sys.stdin)
              repo = d.get('data', {}).get('repository', {})
              bot = ''
              for a in repo.get('suggestedActors', {}).get('nodes', []):
                  if a.get('login') == 'copilot-swe-agent':
                      bot = a.get('id', '')
                      break
              issue = repo.get('issue', {}).get('id', '')
              print(bot + '\t' + issue + '\t' + repo.get('id', ''))
          except Exception as e:
              print(f'Python parse error: {e}', file=sys.stderr)
              print('\t\t')
          PY
              ) || true

              if [[ -z "${bot_id}" ]]; then
                echo "WARNING: copilot-swe-agent ã® Bot ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è©¦è¡Œ ${assign_attempt}/${max_assign_retry}" >&2
                sleep "${assign_wait}"
                assign_wait=$((assign_wait * 2))
                continue
              fi
              if [[ -z "${issue_node_id}" ]]; then
                echo "WARNING: Issue #${issue_num} ã® Node ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è©¦è¡Œ ${assign_attempt}/${max_assign_retry}" >&2
                sleep "${assign_wait}"
                assign_wait=$((assign_wait * 2))
                continue
              fi
              if [[ -z "${repo_node_id}" ]]; then
                echo "WARNING: Repository ã® Node ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è©¦è¡Œ ${assign_attempt}/${max_assign_retry}" >&2
                sleep "${assign_wait}"
                assign_wait=$((assign_wait * 2))
                continue
              fi
              echo "  Bot ID: ${bot_id}, Issue Node ID: ${issue_node_id}, Repo Node ID: ${repo_node_id}"

              # addAssigneesToAssignable mutationï¼ˆå…¨å¤‰æ•°ã‚’ -f ãƒ•ãƒ©ã‚°ã§æ¸¡ã™ãƒ»ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢ï¼‰
              local result
              result=$(GH_TOKEN="${COPILOT_PAT}" gh api graphql \
                -H 'GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection' \
                -f query="
          mutation(\$assignableId: ID!, \$botId: ID!, \$targetRepositoryId: ID!, \$baseRef: String!, \$customInstructions: String!, \$customAgent: String!) {
            addAssigneesToAssignable(input: {
              assignableId: \$assignableId,
              assigneeIds: [\$botId],
              agentAssignment: {
                targetRepositoryId: \$targetRepositoryId,
                baseRef: \$baseRef,
                customInstructions: \$customInstructions,
                customAgent: \$customAgent,
                model: \"\"
              }
            }) {
              assignable {
                ... on Issue {
                  id
                  title
                  assignees(first: 10) {
                    nodes { login }
                  }
                }
              }
            }
          }
                " \
                -f assignableId="${issue_node_id}" \
                -f botId="${bot_id}" \
                -f targetRepositoryId="${repo_node_id}" \
                -f baseRef="${base_branch}" \
                -f customInstructions="${custom_instructions}" \
                -f customAgent="${custom_agent}" \
                2>&1) || true

              echo "  GraphQL mutation ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${result}"

              # mutation ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
              local has_errors
              has_errors=$(echo "${result}" | python3 /dev/fd/3 3<<'PY'
          import sys, json
          try:
              d = json.load(sys.stdin)
              print('true' if d.get('errors') else 'false')
          except Exception:
              print('true')
          PY
              ) || true

              if [[ "${has_errors}" == "true" ]]; then
                echo "WARNING: GraphQL mutation ã«ã‚¨ãƒ©ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚è©¦è¡Œ ${assign_attempt}/${max_assign_retry}" >&2
                sleep "${assign_wait}"
                assign_wait=$((assign_wait * 2))
                continue
              fi

              # copilot-swe-agent ãŒ assignees ã«å«ã¾ã‚Œã‚‹ã‹æ¤œè¨¼
              local is_assigned
              is_assigned=$(echo "${result}" | python3 /dev/fd/3 3<<'PY'
          import sys, json
          try:
              d = json.load(sys.stdin)
              nodes = d.get('data', {}).get('addAssigneesToAssignable', {}).get('assignable', {}).get('assignees', {}).get('nodes', [])
              print('true' if any(a.get('login') in ('copilot-swe-agent', 'Copilot') for a in nodes) else 'false')
          except Exception:
              print('false')
          PY
              ) || true

              if [[ "${is_assigned}" == "true" ]]; then
                echo "  copilot-swe-agent ã®ã‚¢ã‚µã‚¤ãƒ³ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚"
                assign_success=true
                break
              fi

              echo "WARNING: copilot-swe-agent ãŒ assignees ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è©¦è¡Œ ${assign_attempt}/${max_assign_retry}" >&2
              sleep "${assign_wait}"
              assign_wait=$((assign_wait * 2))
            done

            if [[ "${assign_success}" != "true" ]]; then
              local fail_msg
              fail_msg=$(printf 'âš ï¸ Copilot coding agent (copilot-swe-agent) ã‚’ Issue #%s ã«ã‚¢ã‚µã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\næ‰‹å‹•ã§ã‚¢ã‚µã‚¤ãƒ³ã™ã‚‹æ‰‹é †:\n1. Issue #%s ã‚’é–‹ã\n2. å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒAssigneesã€ã‹ã‚‰ `copilot-swe-agent` ã‚’é¸æŠã™ã‚‹\n\nå¤±æ•—åŸå› ã¨ã—ã¦è€ƒãˆã‚‰ã‚Œã‚‹ã‚‚ã®:\n- `COPILOT_PAT` ã®æ¨©é™ä¸è¶³ã¾ãŸã¯å¤±åŠ¹\n- Copilot coding agent ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„\n- GraphQL API ã®ä¸€æ™‚çš„ãªéšœå®³' "${issue_num}" "${issue_num}")
              gh issue comment "${issue_num}" --body "${fail_msg}" --repo "$REPO" 2>&1 || true
              echo "WARNING: Issue #${issue_num} ã¸ã®ã‚¢ã‚µã‚¤ãƒ³å¤±æ•—é€šçŸ¥ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚" >&2
              return 1
            fi

            echo "=== Copilot ã‚¢ã‚µã‚¤ãƒ³å®Œäº†: Issue #${issue_num} ==="
            sleep 2
          }

          # â”€â”€ find_parent_issue() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # å„ªå…ˆåº¦é †ã®4æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§è¦ª Issue ç•ªå·ã‚’è§£æ±ºã™ã‚‹ã€‚
          # è¨ºæ–­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å…¨ã¦ >&2ï¼ˆstderrï¼‰ã«å‡ºåŠ›ã—ã€
          # stdout ã«ã¯è¦ª Issue ç•ªå·ï¼ˆæ•°å­—ã®ã¿ï¼‰ã¾ãŸã¯ç©ºæ–‡å­—ã‚’å‡ºåŠ›ã™ã‚‹ã€‚
          find_parent_issue() {
            local issue_num="$1"
            local issue_body="$2"
            local result_parent=""

            # Method 1: Sub Issue body ã® <!-- parent-issue: #NNN -->ï¼ˆæ–°è¦ä½œæˆåˆ†ï¼‰
            result_parent=$(printf '%s' "${issue_body}" \
              | grep -oP '<!--\s*parent-issue:\s*#\K\d+' | head -1 || true)
            if [[ "${result_parent}" =~ ^[0-9]+$ ]]; then
              echo "  Method 1 (parent-issue comment): #${result_parent}" >&2
              printf '%s\n' "${result_parent}"
              return 0
            fi

            # Method 2: Sub Issue body ã® <!-- pr-number: NNN --> â†’ ãã® PR ã® closingIssuesReferences
            local source_pr
            source_pr=$(printf '%s' "${issue_body}" \
              | grep -oP '<!--\s*pr-number:\s*\K\d+' | head -1 || true)
            if [[ "${source_pr}" =~ ^[0-9]+$ ]] && [ "${source_pr}" != "${PR_NUMBER}" ]; then
              result_parent=$(gh pr view "${source_pr}" --repo "${REPO}" \
                --json closingIssuesReferences \
                --jq '.closingIssuesReferences[0].number | tostring' 2>/dev/null \
                | grep -E '^[0-9]+$' | head -1 || true)
              if [[ "${result_parent}" =~ ^[0-9]+$ ]]; then
                echo "  Method 2 (pr-number comment): #${result_parent} via PR #${source_pr}" >&2
                printf '%s\n' "${result_parent}"
                return 0
              fi
            fi

            # Method 3a: GraphQL trackedInIssuesï¼ˆGitHub Sub Issues ãƒã‚¤ãƒ†ã‚£ãƒ–é–¢ä¿‚ï¼‰
            result_parent=$(gh api graphql \
              -f query="
          query(\$owner: String!, \$repo: String!, \$num: Int!) {
            repository(owner: \$owner, name: \$repo) {
              issue(number: \$num) {
                trackedInIssues(first: 1) {
                  nodes { number }
                }
              }
            }
          }
              " \
              -f owner="${OWNER}" \
              -f repo="${REPO_NAME}" \
              -F num="${issue_num}" \
              --jq '.data.repository.issue.trackedInIssues.nodes[0].number | tostring' 2>/dev/null \
              | grep -E '^[0-9]+$' | head -1 || true)
            if [[ "${result_parent}" =~ ^[0-9]+$ ]]; then
              echo "  Method 3a (GraphQL trackedInIssues): #${result_parent}" >&2
              printf '%s\n' "${result_parent}"
              return 0
            fi

            # Method 3b: <!-- subissues-created --> PR ã‚³ãƒ¡ãƒ³ãƒˆçµŒç”±ï¼ˆå…¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            # ã“ã® Issue ã® timeline ã‹ã‚‰ cross-reference PRs ã‚’å–å¾—ã—ã€
            # <!-- subissues-created --> ãƒãƒ¼ã‚«ãƒ¼ã‚’æŒã¤ PR ã‚’ç‰¹å®šã—ã¦è¦ª Issue ã‚’è§£æ±ºã™ã‚‹
            local xref_prs
            xref_prs=$(gh api "/repos/${REPO}/issues/${issue_num}/timeline?per_page=100" \
              --jq '[.[] | select(.event == "cross-referenced") | select(.source.issue.pull_request != null) | .source.issue.number] | .[]' \
              2>/dev/null || true)

            for xref_pr in $xref_prs; do
              [[ "${xref_pr}" =~ ^[0-9]+$ ]] || continue
              # ç¾åœ¨ãƒãƒ¼ã‚¸ã•ã‚ŒãŸ PR ã¯ skipï¼ˆãã‚Œè‡ªä½“ã¯ä½œæˆPR ã§ã¯ãªãä½œæ¥­PRï¼‰
              [ "${xref_pr}" = "${PR_NUMBER}" ] && continue

              local marker_count
              marker_count=$(gh api "/repos/${REPO}/issues/${xref_pr}/comments?per_page=100" \
                --jq '[.[] | select(.body | contains("<!-- subissues-created -->"))] | length' \
                2>/dev/null || echo "0")
              if [ "${marker_count:-0}" -gt 0 ] 2>/dev/null; then
                result_parent=$(gh pr view "${xref_pr}" --repo "${REPO}" \
                  --json closingIssuesReferences \
                  --jq '.closingIssuesReferences[0].number | tostring' 2>/dev/null \
                  | grep -E '^[0-9]+$' | head -1 || true)
                if [[ "${result_parent}" =~ ^[0-9]+$ ]]; then
                  echo "  Method 3b (subissues-created): #${result_parent} via PR #${xref_pr}" >&2
                  printf '%s\n' "${result_parent}"
                  return 0
                fi
              fi
              sleep 0.5  # API ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼ˆMethod 3b ã®å„ PR ãƒã‚§ãƒƒã‚¯é–“ï¼‰
            done

            # è¦ª Issue ç‰¹å®šä¸å¯
            echo "  WARNING: å…¨ Method ã§è¦ª Issue ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" >&2
            return 1
          }

          # â”€â”€ ãƒãƒ¼ã‚¸ã•ã‚ŒãŸ PR ã®ã‚¯ãƒ­ãƒ¼ã‚º Issue ã‚’å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          CLOSING_ISSUES=$(gh pr view "${PR_NUMBER}" --repo "${REPO}" \
            --json closingIssuesReferences \
            --jq '.closingIssuesReferences[].number' 2>/dev/null || true)

          if [ -z "${CLOSING_ISSUES}" ]; then
            echo "PR #${PR_NUMBER} ã« closing issue å‚ç…§ï¼ˆFixes/Closes/Resolves #Nï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          echo "Closing issues: $(printf '%s' "${CLOSING_ISSUES}" | tr '\n' ' ')"

          declare -A PROCESSED_PARENTS
          SUMMARY_ROWS=""

          for ISSUE_NUM in ${CLOSING_ISSUES}; do
            # æ•°å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            [[ "${ISSUE_NUM}" =~ ^[0-9]+$ ]] || { echo "WARNING: ä¸æ­£ãª Issue ç•ªå·: ${ISSUE_NUM}ã€‚ã‚¹ã‚­ãƒƒãƒ—ã€‚" >&2; continue; }

            echo "=== Closing issue #${ISSUE_NUM} ==="

            # Issue ã® title ã¨ body ã‚’ API çµŒç”±ã§å–å¾—
            ISSUE_JSON=$(gh api "/repos/${REPO}/issues/${ISSUE_NUM}" 2>/dev/null || echo '{}')
            ISSUE_TITLE=$(echo "${ISSUE_JSON}" | python3 -c \
              "import sys,json; print(json.load(sys.stdin).get('title',''))" 2>/dev/null || true)
            ISSUE_BODY=$(echo "${ISSUE_JSON}" | python3 -c \
              "import sys,json; d=json.load(sys.stdin); print(d.get('body','') or '')" 2>/dev/null || true)

            # [ASD]/[ASDW] Issue ã¯å°‚ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆauto-software-design.yml ç­‰ï¼‰ãŒå‡¦ç†ã™ã‚‹
            if [[ "${ISSUE_TITLE}" =~ ^\[ASD\] ]] || [[ "${ISSUE_TITLE}" =~ ^\[ASDW\] ]]; then
              echo "  Skipping [ASD]/[ASDW] issue: ${ISSUE_TITLE}"
              continue
            fi

            # è¦ª Issue ã‚’ç‰¹å®šï¼ˆ4æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            # find_parent_issue ã¯ stdout ã«è¦ª Issue ç•ªå·ã®ã¿ã‚’å‡ºåŠ›ã—ã€è¨ºæ–­ã¯ stderr ã¸
            PARENT=$(find_parent_issue "${ISSUE_NUM}" "${ISSUE_BODY}" || true)

            if [[ ! "${PARENT:-}" =~ ^[0-9]+$ ]]; then
              echo "  Issue #${ISSUE_NUM} ã®è¦ª Issue ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã€‚"
              continue
            fi

            echo "  Parent issue: #${PARENT}"

            # åŒä¸€ PR å†…ã§åŒä¸€è¦ª Issue ã‚’é‡è¤‡å‡¦ç†ã—ãªã„
            if [ -n "${PROCESSED_PARENTS[${PARENT}]:-}" ]; then
              echo "  Parent #${PARENT} ã¯ã“ã®å®Ÿè¡Œã§æ—¢ã«å‡¦ç†æ¸ˆã¿ã§ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã€‚"
              continue
            fi
            PROCESSED_PARENTS[${PARENT}]=1

            # è¦ª Issue ã®å…¨ Sub Issues ã‚’å–å¾—ï¼ˆper_page=100 ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
            SUB_ISSUES_JSON=$(gh api "/repos/${REPO}/issues/${PARENT}/sub_issues?per_page=100" \
              2>/dev/null || echo "[]")

            # SUB_ISSUES_JSON ãŒé…åˆ—ã§ãªã„å ´åˆï¼ˆAPI ã‚¨ãƒ©ãƒ¼ç­‰ï¼‰ã®é˜²å¾¡å‡¦ç†
            SUB_COUNT=$(echo "${SUB_ISSUES_JSON}" | python3 -c \
              "import sys,json; d=json.load(sys.stdin); print(len(d) if isinstance(d,list) else 0)" 2>/dev/null || echo "0")
            if [ "${SUB_COUNT:-0}" -eq 0 ] 2>/dev/null; then
              echo "  Parent #${PARENT} ã® Sub Issues ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆ0ä»¶ã¾ãŸã¯å–å¾—ã‚¨ãƒ©ãƒ¼ï¼‰ã€‚ã‚¹ã‚­ãƒƒãƒ—ã€‚"
              continue
            fi
            echo "  Sub Issues: ${SUB_COUNT} ä»¶"

            # å„ Sub Issue ã®ä¾å­˜é–¢ä¿‚ã‚’è©•ä¾¡ã—ã¦ã‚¢ã‚µã‚¤ãƒ³ã‚’å®Ÿæ–½
            while IFS=$'\t' read -r sub_num sub_state sub_title; do
              [ -z "${sub_num}" ] && continue
              [[ "${sub_num}" =~ ^[0-9]+$ ]] || continue

              # ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ‘ã‚¤ãƒ—æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«å´©ã‚Œé˜²æ­¢ï¼‰
              sub_title_safe="${sub_title//|/&#124;}"

              echo "  Sub-issue #${sub_num} (${sub_state}): ${sub_title}"

              # ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿ã¯ã‚¹ã‚­ãƒƒãƒ—
              if [ "${sub_state}" = "closed" ]; then
                echo "    Already closed. Skipping."
                continue
              fi

              # [ASD]/[ASDW] Sub Issue ã¯å°‚ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå‡¦ç†ã™ã‚‹
              if [[ "${sub_title}" =~ ^\[ASD\] ]] || [[ "${sub_title}" =~ ^\[ASDW\] ]]; then
                echo "    Skipping [ASD]/[ASDW] sub-issue."
                continue
              fi

              # Sub Issue ã® body ã‚’å–å¾—
              SUB_BODY=$(gh api "/repos/${REPO}/issues/${sub_num}" \
                --jq '.body // ""' 2>/dev/null || true)

              # ä¾å­˜é–¢ä¿‚ã‚’æŠ½å‡º
              # Method A: ## â³ å‰ææ¡ä»¶ï¼ˆDependenciesï¼‰ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® - #NNN è¡Œï¼ˆIssueç•ªå·å½¢å¼ï¼‰
              # Method B: <!-- depends_on: 213,216 --> HTML ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆIssueç•ªå·å½¢å¼ï¼‰
              #   â€» <!-- depends_on: 1,4 --> ã®ã‚ˆã†ãªãƒ–ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å½¢å¼ã¯å¯¾è±¡å¤–
              DEP_NUMS=$(echo "${SUB_BODY}" | python3 /dev/fd/3 3<<'PY'
          import sys, re
          body = sys.stdin.read()
          deps = []
          # Method A: å‰ææ¡ä»¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³
          m = re.search(r'##\s*â³\s*å‰ææ¡ä»¶ï¼ˆDependenciesï¼‰[^\n]*\n(.*?)(?=\n##\s|\Z)', body, re.DOTALL)
          if m:
              deps = re.findall(r'-\s*#(\d+)', m.group(1))
          # Method B: depends_on HTML commentï¼ˆIssueç•ªå·ã¨ã—ã¦è§£é‡ˆã§ãã‚‹å ´åˆã®ã¿ï¼‰
          if not deps:
              m2 = re.search(r'<!--\s*depends_on:\s*(.*?)\s*-->', body)
              if m2:
                  candidates = re.findall(r'#?(\d+)', m2.group(1))
                  # ãƒ–ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé€šå¸¸1-9ç¨‹åº¦ï¼‰ã¨Issueç•ªå·ï¼ˆé€šå¸¸100ä»¥ä¸Šï¼‰ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚
                  # é–¾å€¤10ã‚’ä½¿ç”¨ã€‚Issue #1-#10 ã¸ã®ä¾å­˜ãŒã‚ã‚‹å ´åˆã¯Method Aï¼ˆå‰ææ¡ä»¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’ä½¿ã†ã“ã¨
                  deps = [c for c in candidates if int(c) > 10]
          print(' '.join(deps))
          PY
              ) || true

              if [ -z "${DEP_NUMS}" ]; then
                echo "    No issue-number dependencies found. Skipping (root nodes are handled at creation time)."
                continue
              fi

              echo "    Dependencies: ${DEP_NUMS}"

              # å…¨ä¾å­˜ Issue ãŒã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿ï¼ˆã¾ãŸã¯ completedï¼‰ã‹ç¢ºèª
              ALL_DEPS_CLOSED=true
              for DEP_NUM in ${DEP_NUMS}; do
                [[ "${DEP_NUM}" =~ ^[0-9]+$ ]] || continue
                # API ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: ä¾å­˜ Issue ã”ã¨ã« 0.5ç§’ å¾…æ©Ÿ
                sleep 0.5
                DEP_STATE=$(gh api "/repos/${REPO}/issues/${DEP_NUM}" \
                  --jq '.state // "open"' 2>/dev/null || echo "open")
                echo "    Dep #${DEP_NUM}: ${DEP_STATE}"
                # "closed" ãŠã‚ˆã³ GitHub Issue Types ã® "completed" çŠ¶æ…‹ã‚’å®Œäº†ã¨ã¿ãªã™
                if [ "${DEP_STATE}" != "closed" ] && [ "${DEP_STATE}" != "completed" ]; then
                  ALL_DEPS_CLOSED=false
                  break
                fi
              done

              if [ "${ALL_DEPS_CLOSED}" = "true" ]; then
                echo "    All dependencies resolved. Proceeding with Copilot assignment..."

                # Custom Agent åã‚’ Sub Issue body ã‹ã‚‰æŠ½å‡º
                AGENT=$(echo "${SUB_BODY}" | python3 /dev/fd/3 3<<'PY'
          import sys, re
          body = sys.stdin.read()
          m = re.search(r'>\s*\*\*Custom agent used:\s*([^*]+)\*\*', body)
          print(m.group(1).strip() if m else '')
          PY
                ) || true

                # base_branch = ãƒãƒ¼ã‚¸ã•ã‚ŒãŸ PR ã® head branch
                # ï¼ˆãã®ãƒ–ãƒ©ãƒ³ãƒã«å‰ã® Sub Issue ã®ä½œæ¥­çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ï¼‰
                ASSIGN_STATUS=""
                if [ -z "${COPILOT_PAT:-}" ]; then
                  echo "    COPILOT_PAT æœªè¨­å®šã®ãŸã‚ Copilot ã‚¢ã‚µã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                  ASSIGN_STATUS="â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆCOPILOT_PATæœªè¨­å®šï¼‰"
                else
                  assign_result_code=0
                  assign_copilot "${sub_num}" "${AGENT}" "${PR_HEAD_BRANCH}" "" || assign_result_code=$?
                  case "${assign_result_code}" in
                    0) ASSIGN_STATUS="âœ… ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿" ;;
                    2) ASSIGN_STATUS="â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆCOPILOT_PATæœªè¨­å®šï¼‰" ;;
                    *) ASSIGN_STATUS="âš ï¸ å¤±æ•—" ;;
                  esac
                fi
                SUMMARY_ROWS="${SUMMARY_ROWS}| #${sub_num} | ${sub_title_safe} | ${AGENT:-â€”} | \`${PR_HEAD_BRANCH}\` | ${ASSIGN_STATUS} |\n"
              else
                echo "    Not all dependencies closed yet. Skipping."
              fi
            done < <(echo "${SUB_ISSUES_JSON}" | python3 /dev/fd/3 3<<'PY'
          import sys, json
          try:
              issues = json.load(sys.stdin)
              if not isinstance(issues, list):
                  issues = []
          except Exception:
              issues = []
          for i in issues:
              num = str(i.get('number', ''))
              state = i.get('state', 'open')
              # ã‚¿ãƒ–ãƒ»æ”¹è¡Œã‚’é™¤å»ã—ã¦ãƒ‘ãƒ¼ã‚¹å´©ã‚Œã‚’é˜²ã
              title = i.get('title', '').replace('\t', ' ').replace('\n', ' ').replace('\r', ' ')
              if num:
                  print(num + '\t' + state + '\t' + title)
          PY
            )
          done

          # â”€â”€ PR ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦çµæœã‚µãƒãƒªãƒ¼ã‚’æŠ•ç¨¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ -n "${SUMMARY_ROWS}" ]; then
            {
              printf '## ğŸš€ Sub Issue è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³\n\n'
              printf 'ãƒãƒ¼ã‚¸ã•ã‚ŒãŸ PR #%sï¼ˆhead branch: `%s`ï¼‰ã‚’èµ·ç‚¹ã«ã€ä¾å­˜é–¢ä¿‚ãŒè§£æ±ºã•ã‚ŒãŸ Sub Issue ã« Copilot ã‚’ã‚¢ã‚µã‚¤ãƒ³ã—ã¾ã—ãŸã€‚\n\n' \
                "${PR_NUMBER}" "${PR_HEAD_BRANCH}"
              printf '| # | ã‚¿ã‚¤ãƒˆãƒ« | Custom Agent | base branch | çŠ¶æ…‹ |\n'
              printf '|---|--------|-------------|------------|------|\n'
              printf '%b' "${SUMMARY_ROWS}"
            } > /tmp/advance_comment.md
            gh pr comment "${PR_NUMBER}" \
              --repo "${REPO}" \
              --body-file /tmp/advance_comment.md || true
          else
            echo "ã“ã®å®Ÿè¡Œã§ã¯å‰é€²ã•ã›ãŸ Sub Issue ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆä¾å­˜é–¢ä¿‚ãŒæœªè§£æ±ºã€ã¾ãŸã¯å¯¾è±¡ãªã—ï¼‰ã€‚"
          fi
