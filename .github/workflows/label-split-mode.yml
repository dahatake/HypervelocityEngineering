name: Label split mode PRs

on:
  pull_request:
    paths:
      - 'work/**/plan.md'

jobs:
  label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Add split mode label
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            function findPlanFiles(dir) {
              const results = [];
              for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
                const full = path.join(dir, entry.name);
                if (entry.isDirectory()) results.push(...findPlanFiles(full));
                else if (entry.name === 'plan.md') results.push(full);
              }
              return results;
            }

            const workDir = path.join(process.env.GITHUB_WORKSPACE, 'work');
            if (!fs.existsSync(workDir)) { core.info('No work/ directory found'); return; }

            const plans = findPlanFiles(workDir);
            for (const plan of plans) {
              const content = fs.readFileSync(plan, 'utf8');
              const match = content.match(/<!-- split_decision: (\w+) -->/);
              if (match && match[1] === 'SPLIT_REQUIRED') {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['split-mode', 'plan-only']
                });
                core.info('Added split-mode label');
              }
            }
