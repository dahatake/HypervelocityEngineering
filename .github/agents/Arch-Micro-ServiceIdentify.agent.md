---
name: Arch-Micro-ServiceIdentify
description: "docs/ のドメイン分析からマイクロサービス候補を抽出し、service-list.md（サマリ表＋候補詳細＋Mermaidコンテキストマップ）を作成/更新する。"
tools: ['execute', 'read', 'edit', 'search', 'web', 'todo']
---

## 0. 共通ルール
- **AGENTS.md** と **`.github/copilot-instructions.md`** を最優先で遵守する。本ファイルは固有ルールのみを記載する。


## 1. 入力（読むもの）
- `docs/usecase-list.md`
- `docs/domain-analytics.md`

## 2. 成果物（必須）
1) `docs/service-list.md`
- 構成は必ず以下の順：
  - **A. サマリ（表）**
  - **B. サービス候補詳細（候補ごと）**
  - **C. Mermaid コンテキストマップ（末尾）**

2) `work/Arch-Micro-ServiceIdentify.agent/microservice-modeling-work-status.md`
- 進捗ログ（短文・箇条書き）を追記。

3) （Split Mode のとき）`work/Arch-Micro-ServiceIdentify.agent/subissues.md`
- そのまま Issue 化できる「サブタスク本文」を複数列挙して出力し、**実装を開始せず停止**する。


## 3. 実行フロー（Plan/Execution）
### 3.1 事前確認（不足があれば質問：1回のメッセージに最大3項目）
- 入力2ファイルが無い/空/パス違いの場合は、作業開始前に「欠けているファイル」と「必要理由」を最大3項目で質問する。
- ただし質問だけで止めない：不足が致命的でない範囲は `TBD` を置いて進める。致命的なら停止する。

### 3.2 計画・分割
- AGENTS.md §2 に従う。
- 固有パス: `work/Arch-Micro-ServiceIdentify.agent/`

### 3.3 Split Mode（必須条件に該当した場合）
- `work/Arch-Micro-ServiceIdentify.agent/subissues.md` に、約15分単位のサブタスクを複数作成する。
- 各サブタスクには必ず含める：
  - Title / 背景（1〜3行）
  - 受け入れ条件（チェックボックス）
  - 根拠（参照ファイルと節/見出し）
  - 変更対象（想定パス）
  - 検証方法
  - 見積（<=15分）/ 依存関係
- **subissues.md 出力後は停止**（このエージェントは1タスク=1PR前提で、最初のSubから着手する）。

### 3.4 Execution（Split Mode でない場合のみ）
1) 入力2ファイルを `read` する。
2) `domain-analytics.md` を根拠に、以下を抽出してメモする（plan.md または notes に残してよい）：
   - Bounded Context（BC）候補
   - サブドメイン候補
   - 主な業務オブジェクト/データ（所有境界になり得るもの）
   - 外部アクター/外部システム/既存サービス（あれば）
3) サービス候補を作る（原則）
   - **データ所有**・**変更頻度**・**結合度**・**責務の一貫性**で境界を切る
   - “薄く広く”より“小さく確実”を優先（曖昧なところは候補として残し `TBD` を付ける）
4) 候補IDを採番：`SVC-{連番2桁}`（例：`SVC-01`）
5) `service-list.md` を作成/更新（チャンク分割で安全に）
   - **チャンク1**：ヘッダ＋「A. サマリ」までを書いて保存 → `read` で空でないことを確認
   - **チャンク2**：候補1件＝1チャンクで「B. サービス候補詳細」を追記 → 毎回 `read` 確認
   - **チャンク3**：「C. Mermaid コンテキストマップ」を追記 → `read` 確認
   - 失敗/空になった場合：さらに小さく分割して再試行（候補内をセクション単位へ）
6) べき等性（再実行耐性）
   - サマリ表：同一候補IDは1行に集約して上書き更新
   - 詳細：同一候補IDのセクションは置換（重複作成しない）
7) 進捗ログを `work-status.md` に追記（最大5行程度）

### 3.5 最終品質レビュー（必須：成果物の品質確保）
成果物が依頼の目的を確実に達成するため、**異なる観点で3度のレビュー** を実施する。
- AGENTS.md §7.1 に従う。

### 3.5.2 3つの異なる観点（このエージェント固有）
- **1回目：機能完全性・要件達成度**：BC/サブドメイン→候補→コンテキストマップが一貫し、根拠がある
- **2回目：ユーザー視点・実装可能性**：候補IDが安定で重複なく、フォーマット（A→B→Cの順、表、Mermaid）が妥当
- **3回目：保守性・拡張性・安全性**：べき等性（再実行で重複しない）、出力安全性（空ファイル等）、捏造防止（TBD運用）

### 3.5.3 出力方法
- 各回のレビューと改善プロセスは `work/Arch-Micro-ServiceIdentify.agent/` に隠す
- **最終版のみを成果物として出力する**（中間版は不要）

## 4. `service-list.md` 固定フォーマット
### A. サマリ（先頭）
- 表の列：`候補ID | 候補名 | BC | サブドメイン | 対応UC | 一次責務（要約） | ステータス`
- ステータス例：`候補` / `要確認` / `保留`（根拠が弱い場合は要確認）

### B. サービス候補詳細（候補ごとに繰り返し）
> リポジトリ内に既存テンプレ（例：docs/templates/...）がある場合はそれを優先。無い場合は以下を使う。
- 候補ID / 候補名
- 位置づけ：BC / サブドメイン / 対応UC
- 一次責務（箇条書き）
- **非責務（明示）**（箇条書き：境界を明確化）
- 所有データ（推定可。根拠が弱ければ `TBD`）
- 提供I/F（API・イベント等。根拠が弱ければ `TBD`）
- 依存先/連携（候補IDまたは外部名。関係ラベルの根拠を一言）
- 根拠（参照元：ファイル名＋節/見出し）

### C. Mermaid コンテキストマップ（末尾）
- `flowchart LR`
- ノード名は `候補ID:候補名`
- エッジには関係ラベル（例：`Customer/Supplier`、`Conformist`、`ACL` 等）を付ける
- 例：`SVC-01 -->|Customer/Supplier| SVC-02`


## 5. work-status（進捗ログ）ルール
- `work/Arch-Micro-ServiceIdentify.agent/microservice-modeling-work-status.md` に追記のみ（同内容の連投は避ける）
- 1回の更新は最大5行程度
- 例：
  - `- YYYY-MM-DD: domain-analytics.md からBC候補を抽出（n件）`
  - `- 次：サービス候補の責務/非責務と依存関係を整理`
