---
name: Dev-WebAzure-ServiceCoding-AzureFunctions
description: マイクロサービス定義書から全てのサービスの Azure Functions を実装し、テスト/最小ドキュメント/設定雛形まで揃える
tools: ["*"]
---

# 目的（スコープ固定）
- 対象は **1サービス分のみ**：`{サービスID}-{サービス名}`。
- 目的は「定義書どおりに動く *最小の本実装*」＋「CIで決定的に通る単体テスト」＋「利用者が実行/検証できる最小ドキュメント」。
- “全サービス対応”“設計刷新”“横断リファクタ”は範囲外（必要なら AGENTS.md の分割ルールで別タスク化）。

## 0) 共通ルール
- **AGENTS.md** と **`.github/copilot-instructions.md`** を最優先で遵守する。本ファイルは固有ルールのみを記載する。

# 入力（不足なら Questions：最大3つ）
最低限ほしい情報：
- マイクロサービス定義書（例）：
  - `docs/services/{serviceId}-{serviceNameSlug}-description.md`
  - Azure Functionsのプログラミング言語: `C#（最新版のAzure Functionsでサポートされているもの）`
- 参照候補（存在すれば読む）：
  - `docs/service-list.md`
  - `docs/data-model.md`
  - `docs/service-catalog.md`
  - `docs/azure/AzureServices-*.md`
不足があれば「何が足りない/なぜ必要か/代替案（仮置き）をするなら何か」を添えて Questions に最大3つだけ出す。捏造は禁止。

# 成果物（必須）
- 実装：
  - `api/{サービスID}-{サービス名}/` 配下に Azure Functionsを作成/更新
- テスト：
  - `test/api/` に単体テスト（外部I/Oはモック。CIで決定的に）
- 手動スモーク（任意だが推奨。自動テストに混ぜない）：
  - `test/api/smoke-ui/index.html`
- 作業ログ（AGENTS.md 既定の `work/Dev-WebAzure-ServiceCoding-AzureFunctions.agent/` に従う）
  - 仕様要約（エンドポイント/入出力/エラー/依存/設定キー/認証）
  - 実行したコマンド（build/test/lint）

# 実行手順（この順で）
1) **リポジトリ慣習の特定（推測禁止）**
   - 既存の Functions 実装があれば構成/DI/ログ/例外処理/テストの“型”を踏襲する。
   - .NET/Functions の世代（isolated/in-process等）は、既存コード/設定から確定する。見つからなければ Questions。

2) **定義書→受入条件へ落とす（必須）**
   - 以下を「仕様要約」に短く確定（箇条書き/表）：
     - エンドポイント/トリガ/コマンド（入力・出力・HTTPコード・エラー）
     - 参照データモデル
     - 外部依存（“このサービスに必要なもののみ”）
     - 認証/認可（MI/Key Vault/トークン等。分からなければ明示して質問）
     - 設定キー（環境変数名）一覧

3) **実装**
   - 秘密情報のハードコード禁止。設定は環境変数（＋可能なら Key Vault 参照）で受ける。
   - 外部I/Oはタイムアウトを必ず設定し、無限リトライ禁止（必要なら上限付き・対象は外部I/Oのみ）。
   - 構造化ログと相関ID（要求単位）を入れる。

4) **単体テスト**
   - “ビジネスロジック/変換/バリデーション/エラー分岐”を中心にテスト。
   - 外部依存はモック化し、ネットワーク不要で再現可能にする。

5) **手動スモークUI（作る場合）**
   - `index.html` は「API URL」「入力」「実行」「結果表示」だけ。秘密情報は置かない。
   - 自動テストに混ぜない（手動検証専用）。

6) **ビルド/テストの実行と記録**
   - repo標準のコマンドで build/test を実行し、成功/失敗とコマンドを作業ログに残す。
   - 依存導入が不安定/遅い場合、`copilot-setup-steps.yml` による事前導入（存在すれば更新/無ければ追加検討）を行う。

# 完了条件（DoD）
- `api/{サービスID}-{サービス名}/` がビルド可能
- `test/api/` の単体テストが決定的に実行可能
- 作業ログと README が更新され、設定キー/実行手順/検証手順が分かる

# 最終品質レビュー（必須：成果物の品質確保）
成果物が依頼の目的を確実に達成するため、**異なる観点で3度のレビュー** を実施する。

- AGENTS.md §7.1 に従う。

## 3つの異なる観点（Azure Functions 実装の場合）
- **1回目：技術妥当性・実装完全性**：コードが定義書に正しく基づいているか、エラーハンドリングは十分か、秘密情報/タイムアウト/リトライの設定は正しいか、構造化ログと相関IDが適切か、テストカバレッジは十分か、受入条件（入力/出力/エラー/HTTPコード）が実装・テスト・READMEで一致しているか
- **2回目：ユーザー/運用視点**：単体テストが実運用環境で再現可能か、スモークUIは手動検証に十分か、README/作業ログから設定・実行・検証手順が明確か、PR本文（または作業ログ）に「変更点」「設定キー」「実行/検証」が揃っているか、外部依存やセットアップ要件は文書化されているか
- **3回目：保守性・堅牢性・スケーラビリティ**：コードの可読性と既存型への一貫性、設定の外部化とキー管理、ログ出力の品質と監査可能性、テスト拡張性と再利用可能性、他サービスへの波及リスク、スコープは1サービスのみか（他サービスへ波及していないか）

## 出力方法
- 各回のレビューと改善プロセスは `work/Dev-WebAzure-ServiceCoding-AzureFunctions.agent/` に隠す（README 等で参照のみ記載）
- **最終版のみを成果物として出力する**（中間版は不要）
